{% extends 'base.html' %}

{% block head_scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css">
<link rel="stylesheet" href="/static/css/quill-emoji.css">
{% endblock %}

{% block content %}

{% if links_url %}
<div class="links">
    {% if links_url[0] %}<a href="{{ links_url[0][0] }}">–ü–µ—Ä–≤–æ–µ —á—Ç–µ–Ω–∏–µ</a><br>{% else %}<br>{% endif %}
    {% if links_url[1] %}<a href="{{ links_url[1][0] }}">–í—Ç–æ—Ä–æ–µ —á—Ç–µ–Ω–∏–µ</a><br>{% else %}<br>{% endif %}
    {% if links_url[2] %}<a href="{{ links_url[2][0] }}">–¢—Ä–µ—Ç—å–µ —á—Ç–µ–Ω–∏–µ</a><br>{% else %}<br>{% endif %}
</div>
{% endif %}

<form action="" method="post">
    <div class="row">
        <div class="input-field col s12">
            <input type="text" id="short_subject" name="short_subject" required value="{{ short_subject }}">
            <label for="short_subject">–¢–µ–º–∞ (–í —Ä–µ–µ—Å—Ç—Ä)</label>
        </div>

        <div class="input-field col s10">
            <input type="text" id="question_number" name="question_number" class="question_number" required
                   value="{{ question_number }}" {% if links_url %} disabled {% endif %}>
            <label for="question_number">–ù–æ–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞</label>
        </div>
        <div class="input-field col s1 offset-s1">
            <button type="button" id="loadsDecisionNum" class="btn-small waves-effect waves-light" {% if links_url %}
                    disabled {% endif %}>üîç
            </button>
        </div>

        <!-- –ù–æ–≤—ã–π –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ -->
        <div class="input-field col s12">
            <select id="status" name="status">
                <option value="" disabled>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                {% for value, selected in statuses %}
                <option value="{{ value }}" {{ selected }} >{{ value }}</option>
                {% endfor %}
            </select>
            <label for="status">–°—Ç–∞—Ç—É—Å –≤–æ–ø—Ä–æ—Å–∞</label>
        </div>

        <div class="card col s12">
            <div class="card-content">
                <input type="hidden" name="inquiry" id="inquiry">
                <div>
                    <span class="card-title">–í–æ–ø—Ä–æ—Å (–ò–¥–µ—Ç –≤ –∫–∞–Ω–∞–ª –±–µ–∑ —Ç–µ–º—ã –∫–∞–∫ –Ω–∞–ø–∏—Å–∞–Ω–æ –Ω–∏–∂–µ)</span>
                </div>
                <div id="editor-container">
                    {{ inquiry|safe }}
                </div>
            </div>
        </div>

        <div class="col s12">
            <label>–ß—Ç–µ–Ω–∏–µ</label>
            <p>
                <label>
                    <input type="radio" name="reading" value="1" {{ 'checked' if reading == 1 else '' }} />
                    <span>–ü–µ—Ä–≤–æ–µ —á—Ç–µ–Ω–∏–µ</span>
                </label>
            </p>
            <p>
                <label>
                    <input type="radio" name="reading" value="2" {{ 'checked' if reading == 2 else '' }} />
                    <span>–í—Ç–æ—Ä–æ–µ —á—Ç–µ–Ω–∏–µ</span>
                </label>
            </p>
            <p>
                <label>
                    <input type="radio" name="reading" value="3" {{ 'checked' if reading == 3 else '' }} />
                    <span>–¢—Ä–µ—Ç—å–µ —á—Ç–µ–Ω–∏–µ</span>
                </label>
            </p>
        </div>

        <button type="submit" class="btn waves-effect waves-light col s10 offset-s1">
            –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å<i class="material-icons right">send</i>
        </button>
    </div>
</form>
{% endblock %}

{% block bottom_scripts %}
<script src="/static/quill-emoji.js"></script>

<script>
    var form = document.querySelector('form');
    form.onsubmit = function() {
        var html = quill.root.innerHTML;
        document.getElementById('inquiry').value = html;
    };

    var toolbarOptions = {
        container: [
            ['bold', 'italic', 'underline', 'strike', 'code'],
            ['link'],
            ['clean'],
            ['emoji']
        ],
        handlers: {
            'emoji': function () {}
        }
    }

    var quill = new Quill('#editor-container', {
        modules: {
            "toolbar": toolbarOptions,
            "emoji-toolbar": true,
            "emoji-shortname": true
        },
        theme: 'snow',
    });

    async function getNumber() {
        if (document.querySelector("#question_number").disabled) {
            return; // Exit the function if disabled
        }

        fetch(`/decision/number`)
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json();
        })
        .then(data => {
            document.querySelector("#question_number").value = data.number;
            var currentText = quill.root.innerHTML; // Fetch current content from Quill editor
            var shortSubject = document.querySelector("#short_subject").value;
            quill.root.innerHTML = "<b>–í–æ–ø—Ä–æ—Å " + data.number + ": "+ shortSubject +"</b><br> " + currentText; // Update content in Quill editor
            M.updateTextFields(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
        })
        .catch(error => {
            console.log("There was a problem with the fetch operation:", error.message);
        });
    }
    document.getElementById('loadsDecisionNum').addEventListener('click', getNumber);


</script>
{% endblock %}
