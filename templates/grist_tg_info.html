<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MTL Remote Widget</title>
    <!-- Подключаем Bulma 1.0.2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
    <div class="container">
        <!-- Блок авторизации -->
        <div id="auth-section" class="box" style="display: none;">
            <div class="content">
                <p class="has-text-weight-bold">Для доступа необходимо:</p>
                <ol>
                    <li>Перейти в <a id="bot-link" href="#" target="_blank">бота</a></li>
                    <li>Прислать команду <code>/start grist_auth</code></li>
                    <li>Ввести полученный ключ ниже</li>
                </ol>
                <div class="field has-addons mt-4">
                    <div class="control is-expanded">
                        <input id="auth-key" class="input" type="text" placeholder="Введите ключ">
                    </div>
                    <div class="control">
                        <button id="auth-btn" class="button is-primary">Продолжить</button>
                    </div>
                </div>
                <div id="auth-error" class="has-text-danger mt-2" style="display: none;"></div>
            </div>
        </div>

        <!-- Блок кнопок и контента -->
        <div id="main-section" style="display: none;">
            <div id="buttons-container" class="buttons"></div>
            <div id="content" class="box"></div>
            <!-- Кнопка "Выход" -->
            <button id="logout-btn" class="button is-danger is-fullwidth mt-4">Выход</button>
        </div>
    </div>

<script>
let config = null;
let userId = null;

// Инициализация виджета
grist.ready({
    requiredAccess: 'read table',
    columns: [{name: 'user_id', title: 'User ID', type: 'Text'}]
});

grist.onRecord(function(record) {
    userId = record.user_id;
    initWidget();
});

async function initWidget() {
    const authToken = localStorage.getItem('mtl_grist_auth');

    if (!authToken) {
        showAuthSection();
    } else {
        await loadConfig(authToken);
        showMainSection();
    }
}

function showAuthSection() {
    document.getElementById('auth-section').style.display = 'block';
    document.getElementById('bot-link').href = 'https://t.me/myMTLBot?start=grist';

    document.getElementById('auth-btn').addEventListener('click', async () => {
        const key = document.getElementById('auth-key').value.trim();
        if (!key) return;

        try {
            const response = await fetch('https://eurmtl.me/grist/menu', {
                headers: {'X-Auth-Key': key}
            });

            if (!response.ok) throw new Error('Ошибка авторизации');

            localStorage.setItem('mtl_grist_auth', key);
            await loadConfig(key);
            showMainSection();
            document.getElementById('auth-section').style.display = 'none';

        } catch (error) {
            document.getElementById('auth-error').textContent = error.message;
            document.getElementById('auth-error').style.display = 'block';
        }
    });
}

async function loadConfig(authToken) {
    const response = await fetch('https://eurmtl.me/grist/menu', {
        headers: {'X-Auth-Key': authToken}
    });
    config = await response.json();
    renderButtons();
}

function renderButtons() {
    const container = document.getElementById('buttons-container');
    container.innerHTML = '';

    config.buttons.forEach(btn => {
        const button = document.createElement('button');
        button.className = 'button is-info is-light';
        button.textContent = btn.title;

        button.addEventListener('click', async () => {
            try {
                const url = btn.endpoint
                    .replace('{user_id}', encodeURIComponent(userId));

                const response = await fetch(url, {
                    headers: {'X-Auth-Key': localStorage.getItem('mtl_grist_auth')}
                });

                const html = await response.text();
                document.getElementById('content').innerHTML = html;

            } catch (error) {
                document.getElementById('content').innerHTML =
                    `<div class="notification is-danger">Ошибка: ${error.message}</div>`;
            }
        });

        container.appendChild(button);
    });
}

function showMainSection() {
    document.getElementById('main-section').style.display = 'block';

    // Добавляем обработчик для кнопки "Выход"
    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('mtl_grist_auth'); // Удаляем ключ
        location.reload(); // Перезагружаем виджет
    });
}
</script>
</body>
</html>